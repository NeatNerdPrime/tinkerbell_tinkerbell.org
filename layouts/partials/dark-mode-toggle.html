{{/*
  Dark Mode Toggle Script
  Consolidated script for theme cycling, keyboard accessibility, and dynamic ARIA updates.
  Include this partial at the end of <body> in all baseof.html files.
*/}}
<script>
(function() {
  var STORAGE_KEY = 'hugo-geekdoc';
  var MODES = ['auto', 'dark', 'light'];
  var ARIA_LABELS = {
    'auto': 'Color theme: auto (follows system). Click to switch to dark mode.',
    'dark': 'Color theme: dark. Click to switch to light mode.',
    'light': 'Color theme: light. Click to switch to auto mode.'
  };
  
  function getStoredTheme() {
    try {
      var data = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
      return data['color-theme'] || 'auto';
    } catch(e) { return 'auto'; }
  }
  
  function setTheme(mode) {
    var html = document.documentElement;
    // Remove all mode classes
    MODES.forEach(function(m) { html.classList.remove('color-toggle-' + m); });
    // Add the current mode class
    html.classList.add('color-toggle-' + mode);
    // Set or remove color-theme attribute
    if (mode === 'auto') {
      html.removeAttribute('color-theme');
    } else {
      html.setAttribute('color-theme', mode);
    }
    // Save to localStorage
    try {
      var data = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
      data['color-theme'] = mode;
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    } catch(e) {}
    
    // Update ARIA attributes on toggle button
    updateToggleAria(mode);
  }
  
  function updateToggleAria(mode) {
    var toggle = document.getElementById('gdoc-color-theme');
    if (toggle) {
      toggle.setAttribute('aria-label', ARIA_LABELS[mode] || ARIA_LABELS['auto']);
    }
  }
  
  function cycleTheme() {
    var current = getStoredTheme();
    var idx = MODES.indexOf(current);
    var next = MODES[(idx + 1) % MODES.length];
    setTheme(next);
  }
  
  // Initialize theme from storage (should already be set by theme-init.html, but ensure consistency)
  var stored = getStoredTheme();
  setTheme(stored);
  
  // Attach click and keyboard handlers when DOM is ready
  function attachHandler() {
    var toggle = document.getElementById('gdoc-color-theme');
    if (!toggle) {
      // Toggle not present (e.g., some pages may not have it)
      return;
    }
    
    if (toggle._themeHandlerAttached) {
      return;
    }
    toggle._themeHandlerAttached = true;
    
    toggle.addEventListener('click', function(e) {
      e.preventDefault();
      cycleTheme();
    });
    
    // Accessibility: Handle both Enter and Space keys for button activation
    toggle.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        cycleTheme();
      }
    });
    
    // Set initial ARIA state
    updateToggleAria(getStoredTheme());
  }
  
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', attachHandler);
  } else {
    attachHandler();
  }
  
  // Listen for system theme changes when in auto mode
  window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function() {
    // Theme class doesn't change, but we may want to trigger re-renders
    // Currently handled by CSS media queries
  });
})();
</script>
